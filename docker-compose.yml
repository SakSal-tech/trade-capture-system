# docker-compose: orchestrates backend and frontend for local development
# - backend: built from ./backend, exposed on host:8080
# - frontend: built from ./frontend and served by nginx on container:80 mapped to host:3000
# - backend healthcheck probes /actuator/health (enable Spring Actuator for readiness)
# - restart policies help keep services up during local development

services:
  backend:
    build: ./backend
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=local
    restart: unless-stopped
    healthcheck:
      test:
        ["CMD-SHELL", "curl -f http://localhost:8080/actuator/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
    # Use a named volume for the H2 data directory to avoid host-permission issues
    volumes:
      - backend-data:/app/data

  frontend:
    build: ./frontend
    ports:
      - "3000:80"
    depends_on:
      - backend
    restart: unless-stopped

volumes:
  # Named volume where H2 will store its files; Docker manages permissions for us
  backend-data:
